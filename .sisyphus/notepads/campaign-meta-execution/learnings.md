# Campaign Meta-Execution — Learnings

## [2026-01-26] Prerequisites Complete

### P1: PR #172 Merge
- Status: Already merged to main (commit `efcd97cd`)
- No action needed

### P2: Retroactive OpenSpec for Plan 1
- Created `update-day-advancement-pipeline` change
- Documented plugin/registry architecture (1 MODIFIED + 11 ADDED requirements)
- Validated and archived successfully
- All 94 specs validate after archive

### P3: Archive Quick Session Mode
- Archived `add-quick-session-mode` change
- Created new spec: `openspec/specs/quick-session/spec.md`
- No conflicts with campaign work

### P4: Verify Externalize MM Data Assets
- Checked `externalize-mm-data-assets` status: 24/33 tasks complete
- Remaining 9 tasks are manual validation (desktop bundling, local workflow, fresh clone)
- NO CONFLICT: Safe to proceed with campaign branches
- These tasks don't touch campaign code or specs

## [2026-01-26] Plan 7 Phase A Complete

### OpenSpec Proposal Created
- Change-ID: `add-skills-expansion`
- Files created:
  - `proposal.md` - Why, What Changes, Impact
  - `tasks.md` - 6 implementation phases (7.1-7.6)
  - `specs/skills-system/spec.md` - 5 ADDED requirements with 22 scenarios
  - `specs/personnel-management/spec.md` - 1 MODIFIED requirement with 5 scenarios
- Validation: `openspec validate add-skills-expansion --strict` PASSED

### Delegation Lessons
- Initial attempts failed with "No assistant response" and "JSON Parse error"
- Workaround: Created proposal.md directly, then delegated remaining files
- Success pattern: One file at a time, simple prompts, use session continuation
- Subagent correctly refused multi-task request (good boundary enforcement)

## Conventions Established

### OpenSpec Workflow
1. Create proposal → validate → get approval
2. Implement → complete tasks.md
3. Archive → commit to main

### Spec Delta Format
- MODIFIED: Full requirement text with changes
- ADDED: New requirements with scenarios
- Every requirement needs `#### Scenario:` (4 hashtags)
- Scenarios use GIVEN/WHEN/THEN format

### Naming Conventions
- Change-ID: `add-{feature}` or `update-{feature}`
- Branch: `feat/{change-id}`
- Archive: `YYYY-MM-DD-{change-id}`

## Next: Plan 7 Phase B (Implementation)

After user approval of the proposal, proceed to implementation:
- Create branch `feat/add-skills-expansion`
- Implement tasks 7.1-7.6 sequentially
- Run tests after each task
- Mark tasks.md items as complete

## [2026-01-26] Plan 2 Task 2.1: Turnover Modifier Functions

### Implementation Notes
- IPerson lacks birthDate field; used recruitmentDate as proxy for age calculation
- ICampaignOptions lacks turnoverFixedTargetNumber; used optional property access with default 3
- getServiceContractModifier returns 0 (needs per-person contract term tracking)
- Skill desirability uses pilotSkills.gunnery/piloting average mapped to MekHQ experience tiers
- MissionStatus modifier filters to SUCCESS/FAILED/BREACH only, ignores ACTIVE/PENDING

### File Structure
- types.ts: TurnoverModifierResult interface
- personalModifiers.ts: 7 functions (founder, promotion, age, injury, officer, contract, skill)
- campaignModifiers.ts: 2 functions (baseTarget, missionStatus)
- stubModifiers.ts: 10 stub functions with @stub JSDoc tags
- index.ts: barrel export
- __tests__/modifiers.test.ts: 47 tests, 100% pass rate

### Test Results
- 47/47 modifier tests pass
- Full suite: 427 suites, 13183 tests pass, 0 failures

## [2026-01-26] Plan 2 Task 2.2: Core Turnover Check

### Implementation Notes
- RandomFn pattern reused from contractMarket.ts (injectable for testability)
- roll2d6 uses two calls to random(): `Math.floor(r()*6)+1` per die
- Seeded random helper: `randomFor2d6(die1, die2)` maps die values to random() inputs via `(die-1)/6`
- Desertion threshold: roll < targetNumber - 4 → deserted (0 payout), else retired (salary × 12)
- Money class has no `fromAmount` static — use `new Money(amount)` constructor
- MapIterator requires `Array.from()` wrapper (no downlevelIteration flag)
- Commander immunity via extended options pattern: `campaign.options as ICampaignOptions & TurnoverExtendedOptions`
- Skipped statuses: POW, MIA, STUDENT, KIA, RETIRED, DESERTED, MISSING, AWOL (only ACTIVE processed)

### Files Created
- turnoverCheck.ts: roll2d6, checkTurnover, runTurnoverChecks, getPersonMonthlySalary, TurnoverCheckResult, TurnoverReport
- __tests__/turnoverCheck.test.ts: 23 tests

### Test Results
- 23/23 turnoverCheck tests pass
- Full suite: 428 suites, 13206 tests pass, 0 failures

## [2026-01-26] Plan 2 Task 2.3: Extend Person with Turnover Fields

### Implementation Notes
- Added 4 optional fields to both IPersonCareer and IPerson (mirrored per existing pattern)
- No createDefaultPerson() factory exists — fields default to undefined naturally
- All fields optional (backward compatible, no migration needed)
- Fields: lastPromotionDate, serviceContractEndDate, departureDate, departureReason

### Test Results
- 4 new tests added to existing Person.test.ts
- 93/93 Person tests pass
- Full suite: 428 suites, 13210 tests pass, 0 failures

## [2026-01-26] Plan 2 Task 2.4: Turnover Day Processor

### Implementation Notes
- Date 3025-06-16 is Thursday in UTC (not Monday as in 2025) — year 3025 day-of-week differs from 2025
- Fixed test to use 3025-06-20 (Monday) and 3025-06-21 (Tuesday)
- isMonday/isFirstOfMonth/isFirstOfYear exported from dayPipeline.ts
- TurnoverFrequency type: weekly/monthly/quarterly/annually/never

### Test Results
- 19/19 turnoverProcessor tests pass
- Full suite: 429 suites, 13229 tests pass, 0 failures

## [2026-01-26] Plan 2 Task 2.5: Turnover Campaign Options

### Implementation Notes
- Added TurnoverFrequency type and 8 turnover options to ICampaignOptions
- Added defaults to createDefaultCampaignOptions()
- Removed ad-hoc TurnoverExtOptions/TurnoverExtendedOptions from turnoverCheck.ts and campaignModifiers.ts
- Updated test helpers in turnoverCheck.test.ts and modifiers.test.ts to include new fields
- turnoverProcessor.ts now imports TurnoverFrequency from Campaign.ts (single source of truth)

### Test Results
- 89/89 turnover tests pass
- Full suite: 429 suites, 13229 tests pass, 0 failures

## [2026-01-26] Plan 2 Task 2.6: Turnover Report UI

### Implementation Notes
- Added TurnoverDepartureEvent type to DayReport (serializable version of TurnoverCheckResult)
- Updated convertToLegacyDayReport to extract turnover_departure events from pipeline
- Updated turnoverProcessor to include modifier data in event.data
- TurnoverReportPanel: expandable departure cards with modifier breakdown
- TurnoverSettingsPanel: 8 controls (toggle, dropdown, 2 number inputs, 4 checkboxes)
- Integrated into DayReportPanel with collectTurnoverDepartures for multi-day aggregation
- No campaign settings page exists yet; TurnoverSettingsPanel is standalone for future integration

### UI Patterns Used
- Card component from @/components/ui
- Tailwind classes: surface-deep, border-theme-subtle, text-theme-primary/secondary/muted
- Color coding: amber-400 for retired, red-400 for deserted, green-400 for positive modifiers
- React.memo + useCallback for performance
- data-testid attributes for integration testing

### Files Created
- src/components/campaign/TurnoverReportPanel.tsx
- src/components/campaign/TurnoverSettingsPanel.tsx
- src/components/campaign/__tests__/TurnoverReportPanel.test.tsx (12 tests)
- src/components/campaign/__tests__/TurnoverSettingsPanel.test.tsx (11 tests)

### Files Modified
- src/lib/campaign/dayAdvancement.ts (added TurnoverDepartureEvent, updated DayReport)
- src/components/campaign/DayReportPanel.tsx (integrated TurnoverReportPanel)
- src/lib/campaign/processors/turnoverProcessor.ts (added modifiers to event data)

### Test Results
- 23/23 new UI tests pass
- Full suite: 431 suites, 13252 tests pass, 0 failures
