#!/usr/bin/env npx tsx
import * as fs from 'fs';

const report = JSON.parse(fs.readFileSync('validation-output/bv-validation-report.json', 'utf-8'));

// Analyze unresolved weapons across all results
const unresolvedWeaponCount: Record<string, number> = {};
let unresolvedTotal = 0;
for (const r of report.results) {
  if (r.issues) {
    for (const issue of r.issues) {
      const m = issue.match(/Unresolved weapon: (.+)/);
      if (m) {
        unresolvedWeaponCount[m[1]] = (unresolvedWeaponCount[m[1]] || 0) + 1;
        unresolvedTotal++;
      }
    }
  }
}

console.log(`=== UNRESOLVED WEAPONS (${unresolvedTotal} total occurrences) ===`);
const sorted = Object.entries(unresolvedWeaponCount).sort((a, b) => b[1] - a[1]);
for (const [weapon, count] of sorted.slice(0, 30)) {
  console.log(`  ${weapon.padEnd(40)} ${count} units`);
}

// Analyze undercalculated units
const underc = report.results.filter((r: any) => r.cause === 'undercalculation');
console.log(`\n=== UNDERCALCULATION (${underc.length} units, avg ${(underc.reduce((s: number, r: any) => s + Math.abs(r.pctDiff), 0) / underc.length).toFixed(1)}%) ===`);

// Group by techBase
const byTech: Record<string, number> = {};
for (const r of underc) byTech[r.techBase] = (byTech[r.techBase] || 0) + 1;
console.log('  By techBase:', JSON.stringify(byTech));

// Check if weaponBV is main issue
let lowWeapBV = 0;
for (const r of underc) {
  if (r.breakdown?.weaponBV !== undefined && r.breakdown.weaponBV < 50) lowWeapBV++;
}
console.log(`  Low weaponBV (<50): ${lowWeapBV} units`);

// Top 20 undercalculated with their breakdown
console.log('\n=== TOP 20 UNDERCALCULATED ===');
const sortedUnderc = underc.sort((a: any, b: any) => a.pctDiff - b.pctDiff);
for (const r of sortedUnderc.slice(0, 20)) {
  const bd = r.breakdown || {};
  console.log(`  ${r.name.padEnd(35)} ref=${r.referenceBV} calc=${r.calculatedBV} (${r.pctDiff.toFixed(1)}%)`);
  console.log(`    weapBV=${bd.weaponBV?.toFixed(0)||'?'} ammoBV=${bd.ammoBV?.toFixed(0)||'?'} offBV=${bd.offensiveBV?.toFixed(0)||'?'} defBV=${bd.defensiveBV?.toFixed(0)||'?'} sf=${bd.speedFactor?.toFixed(2)||'?'}`);
  if (r.issues?.length > 0) console.log(`    issues: ${r.issues.join('; ')}`);
}

// Minor discrepancy analysis
const minor = report.results.filter((r: any) => r.cause === 'minor-discrepancy');
const minorOver = minor.filter((r: any) => r.pctDiff > 0);
const minorUnder = minor.filter((r: any) => r.pctDiff < 0);
console.log(`\n=== MINOR DISCREPANCY DIRECTION ===`);
console.log(`  Over: ${minorOver.length} (avg +${(minorOver.reduce((s: number, r: any) => s + r.pctDiff, 0) / minorOver.length).toFixed(2)}%)`);
console.log(`  Under: ${minorUnder.length} (avg ${(minorUnder.reduce((s: number, r: any) => s + r.pctDiff, 0) / minorUnder.length).toFixed(2)}%)`);

// Check distribution of minor discrepancy %
const pctBuckets = [0, 0, 0, 0, 0]; // 0-1%, 1-2%, 2-3%, 3-4%, 4-5%
for (const r of minor) {
  const abs = Math.abs(r.pctDiff);
  if (abs < 1) pctBuckets[0]++;
  else if (abs < 2) pctBuckets[1]++;
  else if (abs < 3) pctBuckets[2]++;
  else if (abs < 4) pctBuckets[3]++;
  else pctBuckets[4]++;
}
console.log(`  0-1%: ${pctBuckets[0]}, 1-2%: ${pctBuckets[1]}, 2-3%: ${pctBuckets[2]}, 3-4%: ${pctBuckets[3]}, 4-5%: ${pctBuckets[4]}`);
