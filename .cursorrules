# MekStation - Agent Rules and Guidelines

## ğŸš¨ **CRITICAL: BattleTech Rules Documentation**

**ALWAYS reference BattleTech construction rules when working on this project.**

### **Primary Rules Documentation**
- **OpenSpec Specs**: `openspec/specs/` (SINGLE SOURCE OF TRUTH)
- **Constants**: `constants/BattleTechConstructionRules.ts`
- **Full Guides**: `docs/battletech/battletech_*.md`

### **Viewing Specs**
```bash
# List all specs
npx openspec list --specs

# View a specific spec
npx openspec show movement-system --type spec
```

### **When to Reference Rules**
- Implementing or modifying construction calculations
- Adding validation logic
- Working with equipment placement
- Calculating weights, structure, or armor
- Implementing tech level restrictions
- Working with critical slots
- Any BattleTech rule-related code

### **Code References**
- **Single Source of Truth**: `constants/BattleTechConstructionRules.ts`
- **Validation**: `services/ConstructionRulesValidator.ts`
- **Validators**: `services/validation/*.ts`

---

## ğŸ›¡ï¸ **Code Standards**

### **Type Safety**
- ALWAYS use concrete types, never `as any`
- Use defined interfaces and types from `types/` directory
- Use base objects from `getAvailable*` utilities for dropdowns
- Prefer full canonical objects over string types
- **Use enum types from `types/construction/`** instead of string matching:
  - `EngineType.XL_IS` not `engineType.includes('xl')`
  - `GyroType.COMPACT` not `gyroType.includes('compact')`
  - `HeatSinkType.DOUBLE_CLAN` not `heatSinkType.includes('Double')`
- For backward compatibility with legacy string values, create type-safe helper functions

### **Construction Type Enums**
Always prefer enum types from `types/construction/` over string comparisons:

| Type | Enum | Location |
|------|------|----------|
| Engine | `EngineType` | `types/construction/EngineType.ts` |
| Gyro | `GyroType` | `types/construction/GyroType.ts` |
| Structure | `InternalStructureType` | `types/construction/InternalStructureType.ts` |
| Cockpit | `CockpitType` | `types/construction/CockpitType.ts` |
| Armor | `ArmorTypeEnum` | `types/construction/ArmorType.ts` |
| Heat Sink | `HeatSinkType` | `types/construction/HeatSinkType.ts` |

**Example - Type-Safe Helper Function:**
```typescript
// GOOD: Type-safe with backward compatibility
function isDoubleHeatSink(heatSinkType: HeatSinkType | string): boolean {
  if (heatSinkType === HeatSinkType.DOUBLE_IS || 
      heatSinkType === HeatSinkType.DOUBLE_CLAN) {
    return true;
  }
  if (typeof heatSinkType === 'string') {
    return heatSinkType.toLowerCase().includes('double');
  }
  return false;
}

// BAD: String matching without type safety
const isDouble = mech.heatSinkType.includes('Double');
```

### **Forbidden Patterns**
- **NO `as any` Casting**: Silences compiler errors but causes runtime crashes.
- **NO `as unknown as` Double Casting**: Bypasses type safety entirely. Use type guards or conversion functions.
- **NO Legacy Imports**: Do not import from `types/systemComponents.ts`. Use `types/core`.
- **NO Magic Strings**: Use constants (e.g., `TechBase.INNER_SPHERE`) instead of literals.
- **NO Direct Property Access on `unknown`**: Use `isValid*` type guards first.
- **NO String Matching for Component Types**: Use enum comparisons, not `.includes()` or `.toLowerCase()`.
  - Create helper functions if legacy string support is needed.

### **Architecture**
- Follow SOLID principles
- Single Responsibility Principle - one class, one reason to change
- Services end with `Service`, Managers for orchestration only
- Validators end with `Validator`
- Interfaces start with `I` prefix

### **Naming Conventions**
- NO `ServiceImpl`, `V2`, `V3`, `Refactored` suffixes
- NO `Manager` for business logic (use `Service`)
- Use descriptive, clear names

---

## ğŸ—ï¸ **BattleTech Rule Implementation**

### **Construction Rules**
All construction calculations MUST match official BattleTech TechManual rules:
- Structure weight: 10% of tonnage (standard) / 5% (Endo Steel)
- Armor maximum: 2x structure points (except head = 9)
- Engine heat sinks: Rating / 25 (no minimum)
- Minimum total heat sinks: MAX(10, heat-generating weapons)

### **Validation Rules**
All validation MUST enforce BattleTech rules:
- Weight limits cannot be exceeded
- Armor maximums per location
- Critical slot capacity (78 total, location-specific)
- Tech base compatibility
- Era restrictions

### **Code Location**
- **Constants**: `constants/BattleTechConstructionRules.ts` - Single source of truth
- **Validation**: `services/validation/*.ts` - Rule enforcement
- **Calculations**: `utils/constructionRules/*.ts` - Rule calculations

---

## ğŸ“‚ **Documentation Structure**

### **Rules Documentation**
```
openspec/specs/           # SINGLE SOURCE OF TRUTH
â”œâ”€â”€ construction-rules-core/
â”œâ”€â”€ engine-system/
â”œâ”€â”€ gyro-system/
â”œâ”€â”€ armor-system/
â”œâ”€â”€ movement-system/
â”œâ”€â”€ heat-sink-system/
â”œâ”€â”€ weapon-system/
â”œâ”€â”€ equipment-database/
â””â”€â”€ ...

docs/battletech/          # Supplementary guides
â”œâ”€â”€ README.md             # Points to OpenSpec
â””â”€â”€ battletech_*.md       # Comprehensive guides
```

### **Before Making Changes**
1. Read relevant OpenSpec spec (`npx openspec show <spec-name> --type spec`)
2. Check `constants/BattleTechConstructionRules.ts`
3. Review validation services
4. Ensure changes match official rules

---

## ğŸ“ **Project Structure**

### **Type System** (`src/types/`)
```
types/
â”œâ”€â”€ core/                    # Base interfaces (IEntity, ITechBaseEntity, etc.)
â”‚   â”œâ”€â”€ IEntity.ts           # Base entity with id, name, description
â”‚   â”œâ”€â”€ ITechBaseEntity.ts   # Adds techBase, rulesLevel
â”‚   â”œâ”€â”€ ITemporalEntity.ts   # Adds introductionYear, extinctionYear
â”‚   â””â”€â”€ ComponentInterfaces.ts
â”œâ”€â”€ enums/                   # Core enumerations
â”‚   â”œâ”€â”€ TechBase.ts          # INNER_SPHERE, CLAN, BOTH
â”‚   â”œâ”€â”€ RulesLevel.ts        # INTRODUCTORY, STANDARD, ADVANCED, etc.
â”‚   â”œâ”€â”€ Era.ts               # AGE_OF_WAR through DARK_AGE
â”‚   â””â”€â”€ WeightClass.ts       # LIGHT, MEDIUM, HEAVY, ASSAULT
â”œâ”€â”€ construction/            # Construction system types
â”‚   â”œâ”€â”€ EngineType.ts        # Engine definitions
â”‚   â”œâ”€â”€ GyroType.ts          # Gyro definitions
â”‚   â”œâ”€â”€ ArmorType.ts         # Armor types and allocation
â”‚   â””â”€â”€ HeatSinkType.ts      # Heat sink definitions
â”œâ”€â”€ equipment/               # Equipment definitions
â”‚   â”œâ”€â”€ weapons/             # Weapon categories
â”‚   â”‚   â”œâ”€â”€ EnergyWeapons.ts
â”‚   â”‚   â”œâ”€â”€ BallisticWeapons.ts
â”‚   â”‚   â””â”€â”€ MissileWeapons.ts
â”‚   â”œâ”€â”€ AmmunitionTypes.ts
â”‚   â”œâ”€â”€ ElectronicsTypes.ts
â”‚   â”œâ”€â”€ MiscEquipmentTypes.ts
â”‚   â”œâ”€â”€ PhysicalWeaponTypes.ts
â”‚   â””â”€â”€ VariableEquipment.ts # Variable property calculations
â””â”€â”€ unit/                    # Unit-level types
    â”œâ”€â”€ BattleMechInterfaces.ts
    â””â”€â”€ DatabaseSchema.ts
```

### **Utilities** (`src/utils/`)
```
utils/
â”œâ”€â”€ construction/            # Construction calculations
â”‚   â”œâ”€â”€ engineCalculations.ts
â”‚   â”œâ”€â”€ gyroCalculations.ts
â”‚   â”œâ”€â”€ armorCalculations.ts
â”‚   â”œâ”€â”€ movementCalculations.ts
â”‚   â””â”€â”€ heatSinkCalculations.ts
â”œâ”€â”€ equipment/               # Equipment calculations
â”‚   â”œâ”€â”€ EquipmentCalculator.ts     # Unified entry point
â”‚   â””â”€â”€ variableEquipmentCalculations.ts
â”œâ”€â”€ physical/                # Physical property utils
â”‚   â”œâ”€â”€ weightUtils.ts       # ceilToHalfTon, etc.
â”‚   â””â”€â”€ criticalSlotUtils.ts
â”œâ”€â”€ temporal/                # Era/availability utils
â”‚   â””â”€â”€ availabilityUtils.ts
â””â”€â”€ validation/              # Validation utilities
    â””â”€â”€ rules/
```

### **Services** (`src/services/`)
```
services/
â”œâ”€â”€ catalog/                 # Unit catalog management
â”œâ”€â”€ equipment/               # Equipment data access
â””â”€â”€ integration/             # Service orchestration
```

---

## ğŸ”§ **Key Imports**

### **Enums**
```typescript
import { TechBase } from '@/types/enums/TechBase';
import { RulesLevel } from '@/types/enums/RulesLevel';
import { Era } from '@/types/enums/Era';
import { WeightClass } from '@/types/enums/WeightClass';
```

### **Core Interfaces**
```typescript
import { IEntity, ITechBaseEntity, ITemporalEntity } from '@/types/core';
```

### **Equipment Types**
```typescript
import { IWeapon, ALL_STANDARD_WEAPONS } from '@/types/equipment/weapons';
import { IAmmunition, ALL_AMMUNITION } from '@/types/equipment/AmmunitionTypes';
import { IElectronics, ALL_ELECTRONICS } from '@/types/equipment/ElectronicsTypes';
import { IMiscEquipment, MOVEMENT_EQUIPMENT } from '@/types/equipment/MiscEquipmentTypes';
```

### **Construction Types**
```typescript
// Enum types for type-safe comparisons
import { EngineType, getEngineDefinition } from '@/types/construction/EngineType';
import { GyroType, getGyroDefinition } from '@/types/construction/GyroType';
import { InternalStructureType } from '@/types/construction/InternalStructureType';
import { CockpitType, getCockpitDefinition } from '@/types/construction/CockpitType';
import { ArmorTypeEnum, getArmorDefinition } from '@/types/construction/ArmorType';
import { HeatSinkType, getHeatSinkDefinition } from '@/types/construction/HeatSinkType';
```

### **Calculations**
```typescript
import { calculateEngineWeight, calculateEngineRating } from '@/utils/construction/engineCalculations';
import { calculateWalkMP, calculateRunMP } from '@/utils/construction/movementCalculations';
import { calculateEquipmentProperties } from '@/utils/equipment/EquipmentCalculator';
```

---

## ğŸ“‹ **OpenSpec Workflow**

### **Before Any Task**
1. Run `npx openspec list` to see active changes
2. Run `npx openspec list --specs` to see all specs
3. Check if a spec already exists for your capability

### **Creating Changes**
```bash
# Create change proposal
mkdir -p openspec/changes/<change-id>/specs/<capability>

# Required files:
# - proposal.md (why, what, impact)
# - tasks.md (implementation checklist)
# - specs/<capability>/spec.md (ADDED/MODIFIED/REMOVED requirements)

# Validate before implementing
npx openspec validate <change-id> --strict
```

### **After Implementation**
```bash
# Archive the change (applies deltas to main specs)
npx openspec archive <change-id> --yes
```

---

## âš ï¸ **Important Reminders**

1. **BattleTech Rules are IMMUTABLE** - They come from the official TechManual
2. **Single Source of Truth** - OpenSpec specs + `BattleTechConstructionRules.ts`
3. **Always Validate** - Use validation services, don't bypass them
4. **Type Safety First** - No `as any`, use proper types
5. **SOLID Architecture** - Follow established patterns

---

## ğŸ” **Quick Lookup**

### **Common Rules**
- **Structure**: 10% of tonnage (standard), 5% (Endo Steel)
- **Armor Max**: Head = 9, Others = 2x structure
- **Critical Slots**: 78 total (6 head, 12 CT, 12x2 torso, 12x2 arms, 6x2 legs)
- **Engine Heat Sinks**: Rating / 25 (no minimum)
- **Min Total Heat Sinks**: MAX(10, heat-generating weapons)

### **Variable Equipment Formulas**
| Equipment | Weight | Slots | Cost |
|-----------|--------|-------|------|
| Targeting Computer (IS) | ceil(weaponTons / 4) | = weight | weight Ã— 10000 |
| Targeting Computer (Clan) | ceil(weaponTons / 5) | = weight | weight Ã— 10000 |
| MASC (IS) | ceil(rating / 20) | = weight | tonnage Ã— 1000 |
| MASC (Clan) | ceil(rating / 25) | = weight | tonnage Ã— 1000 |
| Supercharger | ceil(engineWeight / 10) | 1 | engineWeight Ã— 10000 |
| Partial Wing | tonnage Ã— 0.05 | 6 (3 per torso) | weight Ã— 50000 |
| TSM | 0 | 6 | tonnage Ã— 16000 |

### **Key Files**
- Specs: `openspec/specs/`
- Constants: `constants/BattleTechConstructionRules.ts`
- Validation: `services/ConstructionRulesValidator.ts`
- Types: `src/types/`
- Calculations: `src/utils/construction/`
- Equipment Calculator: `src/utils/equipment/EquipmentCalculator.ts`

---

**Last Updated**: 2025-12-13
**Version**: 3.1
